<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>èŠå¤©å®¤ç®¡ç†é¢æ¿</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        input, textarea, button {
            margin: 5px;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            cursor: pointer;
        }
        button:hover {
            background: #0056b3;
        }
        button.danger {
            background: #dc3545;
        }
        button.danger:hover {
            background: #c82333;
        }
        .user-item, .ip-item {
            padding: 8px;
            margin: 5px 0;
            background: #f8f9fa;
            border-radius: 4px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .muted {
            color: #dc3545;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ’¬ èŠå¤©å®¤ç®¡ç†é¢æ¿</h1>
        
        <div class="section">
            <h3>ğŸ“Š æœåŠ¡å™¨çŠ¶æ€</h3>
            <div id="server-status">åŠ è½½ä¸­...</div>
            <button onclick="loadServerStatus()">åˆ·æ–°çŠ¶æ€</button>
        </div>

        <div class="section">
            <h3>ğŸ‘¥ åœ¨çº¿ç”¨æˆ·ç®¡ç†</h3>
            <button onclick="loadUsers()">åˆ·æ–°ç”¨æˆ·åˆ—è¡¨</button>
            <div id="users-list"></div>
        </div>

        <div class="section">
            <h3>ğŸ”‡ IPç¦è¨€ç®¡ç†</h3>
            <input type="text" id="ip-input" placeholder="è¾“å…¥è¦ç¦è¨€çš„IPåœ°å€">
            <button onclick="muteIP()">ç¦è¨€IP</button>
            <button onclick="unmuteIP()">è§£é™¤ç¦è¨€</button>
            <div id="muted-ips-list"></div>
        </div>

        <div class="section">
            <h3>ğŸ“¢ ç®¡ç†å‘˜å¹¿æ’­</h3>
            <textarea id="broadcast-message" placeholder="è¾“å…¥å¹¿æ’­æ¶ˆæ¯" rows="3" style="width: 100%;"></textarea>
            <button onclick="sendBroadcast()">å‘é€å¹¿æ’­</button>
        </div>

        <div class="section">
            <h3>ğŸ’¬ æˆ¿é—´åˆ—è¡¨</h3>
            <button onclick="loadRooms()">åˆ·æ–°æˆ¿é—´åˆ—è¡¨</button>
            <div id="rooms-list"></div>
        </div>
    </div>

    <script>
        const SERVER_URL = 'http://192.168.2.10:3001';

        // åŠ è½½æœåŠ¡å™¨çŠ¶æ€
        async function loadServerStatus() {
            try {
                const response = await fetch(`${SERVER_URL}/api/health`);
                const data = await response.json();
                document.getElementById('server-status').innerHTML = `
                    <p>âœ… æœåŠ¡å™¨è¿è¡Œæ­£å¸¸</p>
                    <p>åœ¨çº¿ç”¨æˆ·: ${data.users}äºº</p>
                    <p>èŠå¤©æˆ¿é—´: ${data.rooms}ä¸ª</p>
                    <p>è¢«ç¦è¨€IP: ${data.mutedIPs}ä¸ª</p>
                    <p>æœåŠ¡å™¨IP: ${data.serverIP}</p>
                `;
            } catch (error) {
                document.getElementById('server-status').innerHTML = 'âŒ æ— æ³•è¿æ¥æœåŠ¡å™¨';
            }
        }

        // åŠ è½½ç”¨æˆ·åˆ—è¡¨
        async function loadUsers() {
            try {
                const response = await fetch(`${SERVER_URL}/api/users`);
                const users = await response.json();
                
                let html = '<h4>åœ¨çº¿ç”¨æˆ·åˆ—è¡¨:</h4>';
                users.forEach(user => {
                    html += `
                        <div class="user-item">
                            <div>
                                <strong>${user.username}</strong> 
                                (IP: ${user.ip})
                                ${user.isMuted ? '<span class="muted">[å·²ç¦è¨€]</span>' : ''}
                            </div>
                            <div>
                                <button onclick="muteUserIP('${user.ip}')" ${user.isMuted ? 'disabled' : ''}>ç¦è¨€</button>
                                <button onclick="unmuteUserIP('${user.ip}')" ${!user.isMuted ? 'disabled' : ''}>è§£ç¦</button>
                            </div>
                        </div>
                    `;
                });
                document.getElementById('users-list').innerHTML = html;
            } catch (error) {
                document.getElementById('users-list').innerHTML = 'âŒ åŠ è½½ç”¨æˆ·åˆ—è¡¨å¤±è´¥';
            }
        }

        // ç¦è¨€æŒ‡å®šIP
        async function muteIP() {
            const ip = document.getElementById('ip-input').value.trim();
            if (!ip) return alert('è¯·è¾“å…¥IPåœ°å€');

            try {
                const response = await fetch(`${SERVER_URL}/api/mute-ip`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ ip })
                });
                const result = await response.json();
                alert(result.message);
                loadUsers();
                loadMutedIPs();
            } catch (error) {
                alert('ç¦è¨€æ“ä½œå¤±è´¥');
            }
        }

        // è§£é™¤ç¦è¨€
        async function unmuteIP() {
            const ip = document.getElementById('ip-input').value.trim();
            if (!ip) return alert('è¯·è¾“å…¥IPåœ°å€');

            try {
                const response = await fetch(`${SERVER_URL}/api/unmute-ip`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ ip })
                });
                const result = await response.json();
                alert(result.message);
                loadUsers();
                loadMutedIPs();
            } catch (error) {
                alert('è§£é™¤ç¦è¨€æ“ä½œå¤±è´¥');
            }
        }

        // ç¦è¨€ç”¨æˆ·IP
        async function muteUserIP(ip) {
            try {
                const response = await fetch(`${SERVER_URL}/api/mute-ip`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ ip })
                });
                const result = await response.json();
                alert(result.message);
                loadUsers();
                loadMutedIPs();
            } catch (error) {
                alert('ç¦è¨€æ“ä½œå¤±è´¥');
            }
        }

        // è§£é™¤ç”¨æˆ·ç¦è¨€
        async function unmuteUserIP(ip) {
            try {
                const response = await fetch(`${SERVER_URL}/api/unmute-ip`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ ip })
                });
                const result = await response.json();
                alert(result.message);
                loadUsers();
                loadMutedIPs();
            } catch (error) {
                alert('è§£é™¤ç¦è¨€æ“ä½œå¤±è´¥');
            }
        }

        // åŠ è½½è¢«ç¦è¨€çš„IPåˆ—è¡¨
        async function loadMutedIPs() {
            try {
                const response = await fetch(`${SERVER_URL}/api/muted-ips`);
                const mutedIPs = await response.json();
                
                let html = '<h4>è¢«ç¦è¨€çš„IPåˆ—è¡¨:</h4>';
                if (mutedIPs.length === 0) {
                    html += '<p>æš‚æ— è¢«ç¦è¨€çš„IP</p>';
                } else {
                    mutedIPs.forEach(ip => {
                        html += `
                            <div class="ip-item">
                                <span>${ip}</span>
                                <button onclick="unmuteUserIP('${ip}')">è§£é™¤ç¦è¨€</button>
                            </div>
                        `;
                    });
                }
                document.getElementById('muted-ips-list').innerHTML = html;
            } catch (error) {
                document.getElementById('muted-ips-list').innerHTML = 'âŒ åŠ è½½ç¦è¨€åˆ—è¡¨å¤±è´¥';
            }
        }

        // å‘é€å¹¿æ’­æ¶ˆæ¯
        async function sendBroadcast() {
            const message = document.getElementById('broadcast-message').value.trim();
            if (!message) return alert('è¯·è¾“å…¥å¹¿æ’­æ¶ˆæ¯');

            try {
                const response = await fetch(`${SERVER_URL}/api/broadcast`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ message })
                });
                const result = await response.json();
                alert(result.message);
                document.getElementById('broadcast-message').value = '';
            } catch (error) {
                alert('å¹¿æ’­å‘é€å¤±è´¥');
            }
        }

        // åŠ è½½æˆ¿é—´åˆ—è¡¨
        async function loadRooms() {
            try {
                const response = await fetch(`${SERVER_URL}/api/rooms`);
                const rooms = await response.json();
                
                let html = '<h4>èŠå¤©æˆ¿é—´åˆ—è¡¨:</h4>';
                rooms.forEach(room => {
                    html += `
                        <div class="user-item">
                            <strong>${room.name}</strong>
                            <span>ç”¨æˆ·æ•°: ${room.userCount}</span>
                        </div>
                    `;
                });
                document.getElementById('rooms-list').innerHTML = html;
            } catch (error) {
                document.getElementById('rooms-list').innerHTML = 'âŒ åŠ è½½æˆ¿é—´åˆ—è¡¨å¤±è´¥';
            }
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨åˆ·æ–°æ•°æ®
        document.addEventListener('DOMContentLoaded', function() {
            loadServerStatus();
            loadUsers();
            loadMutedIPs();
            loadRooms();
        });
    </script>
</body>
</html>